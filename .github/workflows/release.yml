# =============================================================================
# WATCHMEN - Release Workflow
# =============================================================================
# Runs on: tag push (v*)
# Creates GitHub release with Windows binary and install scripts
# =============================================================================

name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  GO_VERSION: "1.25.6"

jobs:
  # ===========================================================================
  # Release Job
  # ===========================================================================
  release:
    name: Build and Release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Get version from tag
        id: version
        run: |
          $VERSION = "${{ github.ref_name }}"
          Write-Host "Version: $VERSION"
          echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT

      - name: Build binary
        run: |
          $VERSION = "${{ steps.version.outputs.VERSION }}"
          $COMMIT = "${{ github.sha }}"
          $DATE = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
          
          Write-Host "Building Watchmen $VERSION"
          
          go build -ldflags="-s -w -X main.Version=$VERSION -X main.Commit=$COMMIT -X main.BuildDate=$DATE" -o watchmen.exe ./cmd/watchmen

      - name: Verify binary
        run: |
          Write-Host "=== Binary Info ==="
          .\watchmen.exe version

      - name: Create release archive
        run: |
          # Create release directory
          New-Item -ItemType Directory -Force -Path release
          
          # Copy files
          Copy-Item watchmen.exe release/
          Copy-Item scripts/install.ps1 release/
          Copy-Item scripts/install.bat release/
          Copy-Item scripts/uninstall.ps1 release/
          Copy-Item scripts/uninstall.bat release/
          Copy-Item configs/config.example.yaml release/
          Copy-Item README.md release/
          
          # Create ZIP archive
          Compress-Archive -Path release/* -DestinationPath watchmen-${{ steps.version.outputs.VERSION }}-windows-amd64.zip

      - name: Generate changelog
        id: changelog
        run: |
          $changelog = @"
          ## What's Changed
          
          ### Installation
          
          1. Download and extract the ZIP file
          2. Run ``install.bat`` as Administrator
          3. Edit ``%ProgramData%\Watchmen\config.yaml``
          4. Run ``watchmen reload`` to apply configuration
          
          ### Upgrade
          
          Run ``watchmen update -y`` or download and run ``install.bat`` again.
          
          ### Files Included
          
          - ``watchmen.exe`` - Main executable
          - ``install.ps1`` / ``install.bat`` - Installation scripts
          - ``uninstall.ps1`` / ``uninstall.bat`` - Uninstallation scripts
          - ``config.example.yaml`` - Example configuration
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/...
          "@
          
          # Write to file for release
          $changelog | Out-File -FilePath CHANGELOG.md -Encoding utf8

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            watchmen-${{ steps.version.outputs.VERSION }}-windows-amd64.zip
            watchmen.exe
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
